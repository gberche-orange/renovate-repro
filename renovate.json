{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:base",
    ":disableRateLimiting",
    ":rebaseStalePrs"
  ],

  "ignorePaths": [
    "**/terraform-config/**",
    "vendor/k8s-manifests/**",
    "submodules/**",
    "master-depls/**/k8s-config/manifests/**/test-cases/**"
  ],
  "flux": {
    "fileMatch": [
      "shared-operators/k8s-kustomize-bases/helm/.+/.+\\.y[a]*ml$",
      "shared-operators/k8s-kustomize-bases/00-common/fluxcd",
      ".+/.+/k8s-config/manifests/.+\\.y[a]*ml$"
    ]
  },
  "kubernetes": {
    "fileMatch": [
      "shared-operators/k8s-kustomize-bases/.+\\.y[a]*ml$",
      ".+/.+/k8s-config/manifests/.+\\.y[a]*ml$"
    ],
    "ignorePaths": [
      "shared-operators/k8s-kustomize-bases/services/redis-binding/redis-binding-formatter-helm-chart"
    ]
  },
  "packageRules": [
    {
      "matchDatasources": ["helm"],
      "matchPackageNames": ["ingress-nginx"],
      "versioning": "pep440"
    },
    {
      "matchDatasources": ["helm"],
      "matchPackageNames": [
        "redis"
      ],
      "assignees": [
        "gberche-orange"
      ],
      "description": "prBodyNotes adds additional text. Alternative it customChangeLogUrl when parseable",
      "prBodyNotes": ["Additional changelog at https://github.com/bitnami/charts/blob/master/bitnami/redis/README.md#upgrading"]
    },
    {
      "description": "PR assignee per package. TODO: expand to team",
      "matchDatasources": ["github-tags"],
      "matchPackageNames": [
        "pivotal-cf/shared-redis-release"
      ],
      "assignees": [
        "JCL38-ORANGE"
      ]
    },
    {
      "description": "@gberche-orange assignments",
      "matchPackagePatterns": [
        "crossplane.*",
        "xpkg.upbound.io.*",
        "interoperator",
        "kudobuilder/kuttl",
        "carvel-dev/carvel-kapp-controller",
        "terraform-google-modules/.*",
        "argo-workflows"
      ],
      "assignees": [
        "gberche-orange"
      ]
    },
    {
      "description": "@o-orand assignments",
      "matchPackagePatterns": [
        "concourse*",
        "jcr*"
      ],
      "assignees": [
        "o-orand"
      ]
    },
    {
      "description": "@poblin-orange assignments",
      "matchPackagePatterns": [
        "kyverno"
      ],
      "assignees": [
        "poblin-orange"
      ]
    },
    {
      "description": "@ogrand assignments",
      "matchPackagePatterns": [
        "farmer1992/sshpiperd"
      ],
      "assignees": [
        "ogrand"
      ]
    },
    {
      "description": "@Guilamb assignments",
      "matchPackagePatterns": [
        "confluentinc/ksqldb.*"
      ],
      "assignees": [
        "Guilamb"
      ]
    },
    {
      "description": "Tune versioning to avoid PR proposing v1.1.1 instead of 1.1.1",
      "matchDatasources": ["docker"],
      "matchPackageNames": [
        "boshprometheus/bosh-exporter",
        "boynux/squid-exporter",
        "envoyproxy/envoy",
        "niedbalski/openstack-exporter-linux-amd64",
        "pryorda/vmware_exporter",
        "thanosio/thanos"
      ],
      "versioning": "regex:v?(?<major>\\d+)\\.(?<minor>\\d+)\\.(?<patch>\\d+)?$"
    },
    {
      "matchPackagePrefixes": ["confluentinc/ksqldb-"],
      "customChangelogUrl": "https://github.com/confluentinc/ksql"
    },
    {
      "matchPackageNames": ["starkandwayne/shield-boshrelease"],
      "customChangelogUrl": "https://github.com/shieldproject/shield"
    },
    {
      "matchPackageNames": ["prom/blackbox-exporter"],
      "customChangelogUrl": "https://github.com/prometheus/blackbox_exporter"
    },
    {
      "matchPackageNames": ["interoperator"],
      "customChangelogUrl": "https://github.com/cloudfoundry/service-fabrik-broker/"
    },
    {
      "matchPackageNames": ["kyverno"],
      "customChangelogUrl": "https://github.com/kyverno/kyverno",
      "prBodyNotes": "Check out also https://kyverno.io/blog/"
    },
    {
      "matchPackageNames": ["terraform-operator"],
      "prBodyNotes": "Check out also https://github.com/isaaguilar/terraform-operator/releases"
    },
    {
      "matchPackageNames": ["argo-workflows"],
      "prBodyNotes": "Check out also appVersion version in https://github.com/argoproj/argo-helm/blob/main/charts/argo-workflows/Chart.yaml#L2 release in https://github.com/argoproj/argo-workflows/releases/ https://blog.argoproj.io/ and https://github.com/argoproj/argo-workflows/blob/master/CHANGELOG.md"
    },
    {
      "matchPackageNames": ["kudobuilder/kuttl"],
      "customChangelogUrl": "https://github.com/kudobuilder/kuttl",
      "prBodyNotes": "Check out also https://github.com/kudobuilder/kuttl.dev/commits/master"
    },
    {
      "description": "DISABLED until customChangeUrl template support, see https://github.com/renovatebot/renovate/discussions/18280. crossplane providers docker images are hosted on the crossplane-contrib github org. ",
      "matchDatasources": [ "DISABLED docker"],
      "matchPackagePatterns": [
        "crossplane/provider-.*"
      ],
      "customChangelogUrl": "https://github.com/crossplane-contrib/{{{replace 'crossplane/' '' depName}}}/"
    },
    {
      "description": "crossplane main package is on the crossplane org. This should apply both to helm and any docker datasources",
      "matchPackageNames": ["crossplane"],
      "customChangelogUrl": "https://github.com/crossplane/crossplane/",
      "prBodyNotes": ["also checkout https://blog.upbound.io/, slack channel announcement https://crossplane.slack.com/archives/CEFQCGW1H, and [community meeting agenda](https://docs.google.com/document/d/1q_sp2jLQsDEOX7Yug6TPOv7Fwrys6EwcF5Itxjkno7Y)"]
    },
    {
      "description": "tunes the PR body for concourse",
      "matchPackageNames": ["concourse"],
      "prBodyNotes": ["also checkout https://github.com/concourse/concourse/releases https://github.com/concourse/concourse/discussions"]
    },

    {
      "matchPackageNames": ["crossplanecontrib/provider-gcp"],
      "customChangelogUrl": "https://github.com/crossplane-contrib/provider-gcp/"
    },
    {
      "matchPackageNames": ["crossplanecontrib/provider-helm"],
      "customChangelogUrl": "https://github.com/crossplane-contrib/provider-helm/"
    },
    {
      "matchPackageNames": ["crossplanecontrib/provider-kubernetes"],
      "customChangelogUrl": "https://github.com/crossplane-contrib/provider-kubernetes/"
    },
    {
      "matchPackageNames": ["crossplane/provider-jet-gcp"],
      "customChangelogUrl": "https://github.com/crossplane-contrib/provider-jet-gcp/"
    },
    {
      "matchPackageNames": ["tf-controller"],
      "customChangelogUrl": "https://github.com/weaveworks/tf-controller/",
      "prBodyNotes": ["Checkout also https://github.com/weaveworks/tf-controller/tree/main/charts/tf-controller"]
    },
    {
      "matchPackageNames": ["xpkg.upbound.io/upbound/provider-gcp"],
      "customChangelogUrl": "https://github.com/upbound/provider-gcp/",
      "prBodyNotes": ["also checkout slack channel announcement https://crossplane.slack.com/archives/CEFQCGW1H, https://github.com/upbound/platform-ref-gcp/ and https://marketplace.upbound.io/providers/upbound/provider-gcp/ with examples and uptest.upbound.io/*-hook or upjet.upbound.io/manual-intervention annotation"]
    },
    {
      "matchPackageNames": ["carvel-dev/carvel-kapp-controller"],
      "description": "blog + manual workaround for https://github.com/renovatebot/renovate/issues/17711",
      "prBodyNotes": ["Checkout Carvel blog at https://carvel.dev/blog/ \n\nUpon merge:\n* [ ] run from bosh-cli `proxy -s; cd vendor; ./vendor.sh ; git add k8s-manifests/github.com/carvel-dev/carvel-kapp-controller/release.yml; git diff; git commit -m \"refresh following bump\""]
    },
    {
      "matchPackageNames": ["carvel-dev/carvel-secretgen-controller \t"],
      "description": "blog + manual workaround for https://github.com/renovatebot/renovate/issues/17711",
      "prBodyNotes": ["Checkout Carvel blog at https://carvel.dev/blog/ \n\nUpon merge:\n* [ ] run from bosh-cli `proxy -s; cd vendor; ./vendor.sh ; git add k8s-manifests/github.com/carvel-dev/carvel-secretgen-controller/release.yml; git diff; git commit -m \"refresh following bump\""]
    },


    {
      "matchPackagePatterns": [".*"],
      "addLabels": ["{{datasource}}"]
    },
    {
      "matchManagers": ["regex"],
      "matchPaths": ["**/root-deployment.yml"],
      "addLabels": [
        "bosh-release",
        "{{#unless (or (containsString depName 'cloudfoundry/bosh-linux-stemcell-builder') (containsString depName 'starkandwayne/shield-boshrelease') (containsString depName 'anotherorg/another-boshrelease')) }}{{replace '.*/(.*)-release' 'brn: $1' depName}}{{/unless}}"],
      "description": "brn=bosh_release_name. Excluded for stemcells. See https://handlebarsjs.com/guide/builtin-helpers.html#unless https://github.com/renovatebot/renovate/blob/main/docs/usage/templates.md#containsstring and https://github.com/renovatebot/renovate/discussions/15833#discussioncomment-2873872 and https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions/Groups_and_Backreferences#using_groups_and_back_references"
    },
    {
      "matchManagers": ["regex"],
      "matchPaths": ["**/root-deployment.yml"],
      "matchPackagePrefixes": ["starkandwayne/shield-boshrelease"],
      "description": "bpn= bosh_process_name. Manually handling shield since it deviates from usual pattern with -release suffix. + Add bpn for more focussed package status checks",
      "addLabels": [
        "brn: shield",
        "bpn: shieldd"
      ]
    },
    {
      "matchManagers": ["regex"],
      "matchFiles": ["vendor/vendir-k8s-manifest.yml"],
      "addLabels": ["vendir"]
    }
  ],

  "regexManagers": [
    {
      "fileMatch": ["shared-operators/docker-images/docker-images-versions-vars\\.yml$"],
      "matchStrings": [
        "(?<depName>[a-z0-9/\\-_]*?): \"(?<currentValue>[a-z0-9\\.\\-]*?)\"\\nn"
      ],
      "datasourceTemplate": "docker",
      "versioningTemplate": "docker"
    },
    {
      "description": "patches image version in values.yaml https://regex101.com/r/Fshep2/1",
      "fileMatch": ["master-depls/00-supervision/k8s-config/manifests/20-kafka-ksqldb-bi/cp-ksql-server-helm-release-patch\\.y[a]*ml$"],
      "matchStrings": [
        "  +image: (?<depName>[a-z0-9\\.\\/\\-]*?)\\n +imageTag: (?<currentValue>[a-z0-9\\.\\/\\-\\+]*?) *\\n"
      ],
      "datasourceTemplate": "docker",
      "versioningTemplate": "docker"
    },
    {
      "description": "patches crossplane provider package version  https://regex101.com/r/3ug5iv/3",
      "fileMatch": [".*/provider.*\\.y[a]*ml$"],
      "matchStrings": [
        "apiVersion: pkg.crossplane.io\\/.*\\nkind: Provider\\n(.*\\n)+(.* package:[ ]*\"?)(?<depName>[a-z0-9\\.\\/\\-]*?):(?<currentValue>[a-z0-9\\.\\/\\-\\+]*?)\"?\\n"
      ],
      "datasourceTemplate": "docker",
      "versioningTemplate": "docker"
    },
    {
      "description": "bump of releases in root-deployment is coa management of bosh released hosted in bosh.io from git tags. Not using github-releases ",
      "fileMatch": [".+/root-deployment\\.yml$"],
      "matchStrings": [
        "( +comments:.*\\n( {6}.*\\n)+)? +repository: (?<depName>[a-z0-9/-]*?)\\n( +sha1: .*\\n)?( +skip_branch_checkout: .*\\n)?( +tag_prefix: (?<tagPrefix>.*)\\n)? +version: '?(?<currentValue>[a-zA-Z0-9\\.\\-]*?)'?\\n"
      ],
      "datasourceTemplate": "github-tags",
      "versioningTemplate": "loose",
      "extractVersionTemplate": "{{#if tagPrefix}}(?<version>.*){{else}}^v(?<version>.*){{/if}}"
    },
    {
      "description": "bump of stemcell version within root-deployment.yaml: bosh stemcell hosted in bosh.io from github release tags. Not using github tags as they also include transient release candidates. matchStrings: https://regex101.com/r/3Gzhig/1 extracts: jammy currentValue=1.174  expecting tag=ubuntu-bionic/v1.195 and extractVersionTemplate: https://regex101.com/r/ZrrDJ2/1 See regex doc at https://docs.renovatebot.com/modules/manager/regex/",
      "fileMatch": [".+/root-deployment\\.yml$"],
      "matchStrings": [
        "stemcell:\\n.*version: '(?<currentValue>[1-9.]+)'"
      ],
      "depNameTemplate": "cloudfoundry/bosh-linux-stemcell-builder",
      "datasourceTemplate": "github-releases",
      "versioningTemplate": "regex:(?<major>\\d+)\\.(?<minor>\\d+)$",

      "extractVersionTemplate": "ubuntu-bionic\/v(?<version>.*)$"
    },
    {
      "description": "https://regex101.com/r/ms9hZL/1",
      "fileMatch": ["vendor/vendir-k8s-manifest.yml$"],
      "matchStrings": [
        " +githubRelease:\\n +slug: (?<depName>[a-z0-9\\.\\/\\-]*?)\\n +tag: (?<currentValue>[a-z0-9\\.\\/\\-\\+]*?) *\\n"
      ],
      "datasourceTemplate": "github-releases",
      "versioningTemplate": "regex:v?(?<major>\\d+)\\.(?<minor>\\d+)\\.(?<patch>\\d+)?$"
    },
    {
      "description": "https://regex101.com/r/boCv4J/1",
      "fileMatch": ["vendor/vendir-k8s-manifest.yml$"],
      "matchStrings": [
        " +git:\\n +url: https:\\/\\/github\\.com\\/(?<depName>[a-z0-9\\.\\/\\-:]*?)\\n +ref: (?<currentValue>[a-z0-9\\.\\/\\-\\+]*?) *\\n"
      ],
      "datasourceTemplate": "github-tags",
      "versioningTemplate": "regex:v?(?<major>\\d+)\\.(?<minor>\\d+)\\.(?<patch>\\d+)?$"
    }
  ]

}



