{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:base",
    ":disableRateLimiting",
    ":rebaseStalePrs"
  ],

  "ignorePaths": [
    "**/terraform-config/**",
    "vendor/k8s-manifests/**",
    "submodules/**",
    "master-depls/**/k8s-config/manifests/**/test-cases/**"
  ],
  "flux": {
    "fileMatch": [
      "shared-operators/k8s-kustomize-bases/helm/.+/.+\\.yaml$",
      "shared-operators/k8s-kustomize-bases/00-common/fluxcd",
      ".+/.+/k8s-config/manifests/.+\\.yaml$"
    ]
  },
  "kubernetes": {
    "fileMatch": [
      "shared-operators/k8s-kustomize-bases/.+\\.yaml$",
      ".+/.+/k8s-config/manifests/.+\\.yaml$"
    ],
    "ignorePaths": [
      "shared-operators/k8s-kustomize-bases/services/redis-binding/redis-binding-formatter-helm-chart"
    ]
  },
  "packageRules": [
    {
      "matchDatasources": ["helm"],
      "matchPackageNames": ["ingress-nginx"],
      "versioning": "pep440"
    },
    {
      "matchDatasources": ["helm"],
      "matchPackageNames": [
        "redis"
      ],
      "assignees": [
        "gberche-orange"
      ],
      "description": "prBodyNotes adds additional text. Alternative it customChangeLogUrl when parseable",
      "prBodyNotes": ["Additional changelog at https://github.com/bitnami/charts/blob/master/bitnami/redis/README.md#upgrading"]
    },
    {
      "description": "PR assignee per package. TODO: expand to team",
      "matchDatasources": ["github-tags"],
      "matchPackageNames": [
        "pivotal-cf/shared-redis-release"
      ],
      "assignees": [
        "JCL38-ORANGE"
      ]
    },
    {
      "description": "Tune versioning to avoid PR proposing v1.1.1 instead of 1.1.1",
      "matchDatasources": ["docker"],
      "matchPackageNames": [
        "boshprometheus/bosh-exporter",
        "boynux/squid-exporter",
        "envoyproxy/envoy",
        "niedbalski/openstack-exporter-linux-amd64",
        "pryorda/vmware_exporter",
        "thanosio/thanos"
      ],
      "versioning": "regex:v?(?<major>\\d+)\\.(?<minor>\\d+)\\.(?<patch>\\d+)?$"
    },
    {
      "matchPackagePrefixes": ["confluentinc/ksqldb-"],
      "customChangelogUrl": "https://github.com/confluentinc/ksql"
    },
    {
      "matchPackageNames": ["starkandwayne/shield-boshrelease"],
      "customChangelogUrl": "https://github.com/shieldproject/shield"
    },
    {
      "matchPackageNames": ["prom/blackbox-exporter"],
      "customChangelogUrl": "https://github.com/prometheus/blackbox_exporter"
    },
    {
      "matchPackageNames": ["interoperator"],
      "customChangelogUrl": "https://github.com/cloudfoundry/service-fabrik-broker/"
    },
    {
      "description": "DISABLED until customChangeUrl template support, see https://github.com/renovatebot/renovate/discussions/18280. crossplane providers docker images are hosted on the crossplane-contrib github org. ",
      "matchDatasources": [ "DISABLED docker"],
      "matchPackagePatterns": [
        "crossplane/provider-.*"
      ],
      "customChangelogUrl": "https://github.com/crossplane-contrib/{{{replace 'crossplane/' '' depName}}}/"
    },
    {
      "description": "crossplane main package is on the crossplane org. This should apply both to helm and any docker datasources",
      "matchPackageNames": ["crossplane"],
      "customChangelogUrl": "https://github.com/crossplane/crossplane/"
    },

    {
      "matchPackageNames": ["crossplane/provider-gcp"],
      "customChangelogUrl": "https://github.com/crossplane-contrib/provider-gcp/"
    },
    {
      "matchPackageNames": ["crossplane/provider-helm"],
      "customChangelogUrl": "https://github.com/crossplane-contrib/provider-helm/"
    },
    {
      "matchPackageNames": ["crossplane/provider-kubernetes"],
      "customChangelogUrl": "https://github.com/crossplane-contrib/provider-kubernetes/"
    },
    {
      "matchPackageNames": ["crossplane/provider-jet-gcp"],
      "customChangelogUrl": "https://github.com/crossplane-contrib/provider-jet-gcp/"
    },


    {
      "matchPackagePatterns": [".*"],
      "addLabels": ["{{datasource}}"]
    },
    {
      "matchManagers": ["regex"],
      "matchPaths": ["root-deployment.yml"],
      "addLabels": [
        "bosh-release",
        "{{#unless (or (containsString depName 'starkandwayne/shield-boshrelease') (containsString depName 'anotherorg/another-boshrelease')) }}{{replace '.*/(.*)-release' 'brn: $1' depName}}{{/unless}}"],
      "description": "brn=bosh_release_name.  See https://handlebarsjs.com/guide/builtin-helpers.html#unless https://github.com/renovatebot/renovate/blob/main/docs/usage/templates.md#containsstring and https://github.com/renovatebot/renovate/discussions/15833#discussioncomment-2873872 and https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions/Groups_and_Backreferences#using_groups_and_back_references"
    },
    {
      "matchManagers": ["regex"],
      "matchPaths": ["root-deployment.yml"],
      "matchPackagePrefixes": ["starkandwayne/shield-boshrelease"],
      "description": "bpn= bosh_process_name. Manually handling shield since it deviates from usual pattern with -release suffix. + Add bpn for more focussed package status checks",
      "addLabels": [
        "brn: shield",
        "bpn: shieldd"
      ]
    },
    {
      "matchManagers": ["regex"],
      "matchPaths": ["vendir-k8s-manifest.yml"],
      "addLabels": ["vendir"]
    }
  ],

  "regexManagers": [
    {
      "fileMatch": ["shared-operators/docker-images/docker-images-versions-vars\\.yml$"],
      "matchStrings": [
        "(?<depName>[a-z0-9/\\-_]*?): \"(?<currentValue>[a-z0-9\\.\\-]*?)\"\\nn"
      ],
      "datasourceTemplate": "docker",
      "versioningTemplate": "docker"
    },
    {
      "description": "patches image version in values.yaml https://regex101.com/r/Fshep2/1",
      "fileMatch": ["master-depls/00-supervision/k8s-config/manifests/20-kafka-ksqldb-bi/cp-ksql-server-helm-release-patch\\.yaml$"],
      "matchStrings": [
        "  +image: (?<depName>[a-z0-9\\.\\/\\-]*?)\\n +imageTag: (?<currentValue>[a-z0-9\\.\\/\\-\\+]*?) *\\n"
      ],
      "datasourceTemplate": "docker",
      "versioningTemplate": "docker"
    },
    {
      "description": "patches crossplane provider package version  https://regex101.com/r/3ug5iv/2",
      "fileMatch": [".*/provider.*\\.yaml$"],
      "matchStrings": [
        "apiVersion: pkg.crossplane.io\\/.*\\nkind: Provider\\n(.*\\n)+(.* package: \"?)(?<depName>[a-z0-9\\.\\/\\-]*?):(?<currentValue>[a-z0-9\\.\\/\\-\\+]*?)\"?\\n"
      ],
      "datasourceTemplate": "docker",
      "versioningTemplate": "docker"
    },
    {
      "description": "root-deployment is coa management of bosh released hosted in bosh.io from git tags. Not using github-releases ",
      "fileMatch": [".+/root-deployment\\.yml$"],
      "matchStrings": [
        "( +comments:.*\\n( {6}.*\\n)+)? +repository: (?<depName>[a-z0-9/-]*?)\\n( +sha1: .*\\n)?( +skip_branch_checkout: .*\\n)?( +tag_prefix: (?<tagPrefix>.*)\\n)? +version: '?(?<currentValue>[a-zA-Z0-9\\.\\-]*?)'?\\n"
      ],
      "datasourceTemplate": "github-tags",
      "versioningTemplate": "loose",
      "extractVersionTemplate": "{{#if tagPrefix}}(?<version>.*){{else}}^v(?<version>.*){{/if}}"
    },
    {
      "description": "https://regex101.com/r/ms9hZL/1",
      "fileMatch": ["vendor/vendir-k8s-manifest.yml$"],
      "matchStrings": [
        " +githubRelease:\\n +slug: (?<depName>[a-z0-9\\.\\/\\-]*?)\\n +tag: (?<currentValue>[a-z0-9\\.\\/\\-\\+]*?) *\\n"
      ],
      "datasourceTemplate": "github-releases",
      "versioningTemplate": "regex:v?(?<major>\\d+)\\.(?<minor>\\d+)\\.(?<patch>\\d+)?$"
    },
    {
      "description": "https://regex101.com/r/boCv4J/1",
      "fileMatch": ["vendor/vendir-k8s-manifest.yml$"],
      "matchStrings": [
        " +git:\\n +url: https:\\/\\/github\\.com\\/(?<depName>[a-z0-9\\.\\/\\-:]*?)\\n +ref: (?<currentValue>[a-z0-9\\.\\/\\-\\+]*?) *\\n"
      ],
      "datasourceTemplate": "github-tags",
      "versioningTemplate": "regex:v?(?<major>\\d+)\\.(?<minor>\\d+)\\.(?<patch>\\d+)?$"
    }
  ]

}



